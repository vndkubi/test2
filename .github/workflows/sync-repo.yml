name: ğŸ”„ Sync from upstream and create PR

on:
  schedule:
    - cron: '0 * * * *' # â° Cháº¡y má»—i giá»
  workflow_dispatch:     # ğŸ§ª Cho phÃ©p cháº¡y thá»§ cÃ´ng

jobs:
  sync:
    runs-on: ubuntu-latest

    permissions:
      contents: write           # Cho phÃ©p ghi ná»™i dung vÃ o repo
      pull-requests: write      # Cho phÃ©p táº¡o Pull Request

    steps:
      - name: ğŸ§¾ Checkout current repository (fork)
        uses: actions/checkout@v4
        with:
          ref: main             # Äáº£m báº£o checkout tá»« nhÃ¡nh main
          fetch-depth: 0        # Cáº§n full history Ä‘á»ƒ merge

      - name: âš™ï¸ Setup Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: ğŸ”— Add upstream remote
        run: git remote add upstream https://github.com/ctson97/test1.git

      - name: ğŸ“¥ Fetch upstream
        run: git fetch upstream || { echo "âŒ Failed to fetch upstream"; exit 1; }

      - name: ğŸ” Check for changes from upstream
        id: check_changes
        run: |
          git checkout main
          git fetch origin main
          git fetch upstream main
          if git diff --quiet origin/main upstream/main; then
            echo "âœ… No changes from upstream. Skipping sync."
            echo "NO_CHANGES=true" >> $GITHUB_ENV
          else
            echo "ğŸ”„ Changes detected from upstream. Proceeding with sync."
            echo "NO_CHANGES=false" >> $GITHUB_ENV
          fi

      - name: ğŸŒ¿ Create sync branch and merge upstream (if changes)
        if: env.NO_CHANGES == 'false'
        run: |
          BRANCH="sync-upstream-$(date +%s)"
          git checkout -b "$BRANCH" || { echo "âŒ Failed to create branch"; exit 1; }
          git merge upstream/main || { echo "âŒ Merge failed"; exit 1; }
          git push origin "$BRANCH" || { echo "âŒ Push failed"; exit 1; }
          echo "BRANCH_NAME=$BRANCH" >> $GITHUB_ENV

      - name: ğŸ” Check if sync branch exists on GitHub (if changes)
        if: env.NO_CHANGES == 'false'
        run: |
          gh api repos/${{ github.repository }}/branches/${{ env.BRANCH_NAME }} \
          || { echo "âŒ Branch not found on remote"; exit 1; }
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: â±ï¸ Wait for GitHub to register new branch (if changes)
        if: env.NO_CHANGES == 'false'
        run: sleep 10

      - name: ğŸš€ Create Pull Request to main (if changes)
        if: env.NO_CHANGES == 'false'
        run: |
          gh pr create \
            --repo ${{ github.repository }} \
            --title "ğŸ”„ Sync from ctson97/test1" \
            --body "Tá»± Ä‘á»™ng Ä‘á»“ng bá»™ tá»« upstream repository [ctson97/test1](https://github.com/ctson97/test1)." \
            --head ${{ env.BRANCH_NAME }} \
            --base main
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}