# ğŸ“„ .github/workflows/sync-upstream.yml
name: ğŸ”„ Sync from upstream and create PR

on:
  schedule:
    - cron: '0 * * * *' # â° Cháº¡y má»—i giá»
  workflow_dispatch:     # ğŸ§ª Cho phÃ©p cháº¡y thá»§ cÃ´ng

jobs:
  sync:
    runs-on: ubuntu-latest

    permissions:
      contents: write           # Cho phÃ©p ghi ná»™i dung vÃ o repo
      pull-requests: write      # Cho phÃ©p táº¡o Pull Request

    steps:
      - name: ğŸ§¾ Checkout current repository (fork)
        uses: actions/checkout@v4
        with:
          ref: main             # Äáº£m báº£o checkout tá»« nhÃ¡nh main
          fetch-depth: 0        # Cáº§n full history Ä‘á»ƒ merge

      - name: âš™ï¸ Setup Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: ğŸ”— Add upstream remote
        run: git remote add upstream https://github.com/ctson97/test1.git

      - name: ğŸ“¥ Fetch upstream & merge into new sync branch
        id: sync
        run: |
          git fetch upstream || { echo "âŒ Failed to fetch upstream"; exit 1; }

          BRANCH="sync-upstream-$(date +%s)"
          git checkout -b "$BRANCH" || { echo "âŒ Failed to create branch"; exit 1; }

          git merge upstream/main || { echo "âŒ Merge failed"; exit 1; }

          echo "Synced at $(date '+%Y-%m-%d %H:%M:%S')" > SYNC_TIMESTAMP

          # ğŸ”’ Náº¿u khÃ´ng cÃ³ thay Ä‘á»•i gÃ¬ -> dá»«ng workflow, khÃ´ng táº¡o PR
          if git diff --quiet && git diff --cached --quiet; then
            echo "âœ… No changes to commit. Skipping push & PR."
            exit 0
          fi

          git push origin "$BRANCH" || { echo "âŒ Push failed"; exit 1; }

          echo "BRANCH_NAME=$BRANCH" >> $GITHUB_ENV

      - name: ğŸ” Check if sync branch exists on GitHub
        run: |
          gh api repos/${{ github.repository }}/branches/${{ env.BRANCH_NAME }} \
          || { echo "âŒ Branch not found on remote"; exit 1; }
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: â±ï¸ Wait for GitHub to register new branch
        run: sleep 10

      - name: ğŸš€ Create Pull Request to main
        run: |
          gh pr create \
            --repo ${{ github.repository }} \
            --title "ğŸ”„ Sync from ctson97/test1" \
            --body "Tá»± Ä‘á»™ng Ä‘á»“ng bá»™ tá»« upstream repository [ctson97/test1](https://github.com/ctson97/test1)." \
            --head ${{ env.BRANCH_NAME }} \
            --base main
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
